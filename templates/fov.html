<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- ç¢ºä¿éŸ¿æ‡‰å¼è¨­è¨ˆ -->
    <title>å¯¦æ™‚è·é›¢åµæ¸¬èˆ‡ FOV è¨ˆç®—</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
        /* CSS Reset and Global Styles */
        * { box-sizing: border-box; }

        body { 
            font-family: 'Inter', Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background-color: #f0f4f8; 
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }
        .container { 
            display: flex; 
            width: 95%; 
            max-width: 1400px; 
            min-height: 80vh;
            background-color: #fff; 
            box-shadow: 0 8px 24px rgba(0,0,0,0.15); 
            border-radius: 16px; 
            overflow: hidden; 
            transition: width 0.3s;
        }

        /* éŸ¿æ‡‰å¼ä½ˆå±€ï¼šå°è¢å¹•æ™‚æ”¹ç‚ºå‚ç›´å †ç–Š */
        @media (max-width: 1024px) {
            .container { flex-direction: column; width: 98%; }
            .video-feed { width: 100% !important; height: auto !important; max-height: 80vh; border-radius: 16px 16px 0 0; }
            .controls { padding: 20px; }
        }

        .video-feed { 
            position: relative; 
            width: 70%; 
            max-width: 960px; 
            height: auto;
            /* ä½¿ç”¨ padding-bottom Hack ä¾†ç¶­æŒ 4:3 æ¯”ä¾‹ (640/480) */
            padding-bottom: 52.5%; 
            flex-shrink: 0; 
            background-color: #000;
        }
        
        .video-feed img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain; 
        }

        .controls { 
            flex-grow: 1; 
            padding: 30px; 
            min-width: 300px; 
            display: flex; /* ä½¿ç”¨ flex æ’ç‰ˆä¾†ç®¡ç†å…©å€‹è¨ˆç®—å€å¡Š */
            flex-direction: column;
            gap: 20px; /* å€å¡Šé–“è· */
        }
        .section-box {
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 12px;
            background-color: #f9f9f9;
        }
        
        h1 { color: #004085; text-align: center; margin-bottom: 25px; font-weight: 700; }
        h2 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px; font-size: 1.5em; }
        h3 { margin-top: 0; color: #555; font-size: 1.2em; }
        
        /* æ‹–æ›³æ¨™è¨˜çš„æ¨£å¼ */
        .marker {
            position: absolute;
            width: 10px;
            height: 60px; 
            top: 50%; 
            transform: translateY(-50%) translateX(-5px); /* å‘å·¦åç§» 5pxï¼Œè®“æ¨™è¨˜ä¸­å¿ƒç·šå°é½Š left åº§æ¨™ */
            cursor: ew-resize;
            z-index: 10;
            opacity: 0.8;
            transition: opacity 0.2s, box-shadow 0.2s;
            border-radius: 3px;
        }
        .marker:hover { opacity: 1.0; box-shadow: 0 0 10px rgba(255, 255, 255, 0.5); }
        #marker-start { background-color: rgba(0, 200, 0, 0.7); left: 15%; } 
        #marker-end { background-color: rgba(0, 0, 200, 0.7); left: 75%; }   

        .result { 
            margin-top: 15px; 
            padding: 20px; 
            border: 4px solid #28a745; 
            background-color: #e9fff0; 
            border-radius: 12px;
        }
        .highlight { 
            font-size: 2.2em; 
            color: #dc3545; 
            font-weight: 900; 
            display: block; 
            margin-top: 5px;
            word-break: break-all;
        }
        .highlight-blue {
            font-size: 2.2em; 
            color: #007bff; 
            font-weight: 900; 
            display: block; 
            margin-top: 5px;
            word-break: break-all;
        }
        label { display: block; margin-top: 20px; font-weight: bold; color: #333; font-size: 1.1em; }
        input[type="number"] { 
            width: 95%; 
            padding: 12px; 
            margin-top: 8px; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            font-size: 1.2em; 
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        p { color: #666; font-size: 1.0em; margin-bottom: 10px;}
    </style>
</head>
<body>
    <h1>ğŸ”­ å¯¦æ™‚è·é›¢åµæ¸¬èˆ‡è¦–é‡è¨ˆç®—</h1>
    
    <div class="container">
        <!-- å½±åƒä¸²æµå€å¡Š -->
        <div class="video-feed" id="video-container">
            <!-- è¦–è¨Šç•«é¢ -->
            <img id="video-stream" src="{{ url_for('video_feed') }}" alt="å³æ™‚è¦–è¨Šä¸²æµ">
            
            <!-- æ‹–æ›³æ¨™è¨˜ -->
            <div class="marker" id="marker-start" data-side="start"></div>
            <div class="marker" id="marker-end" data-side="end"></div>
        </div>

        <!-- è¨ˆç®—æ§åˆ¶å€å¡Š -->
        <div class="controls">
            
            <div class="section-box">
                <h2>1. ç›´å°ºæ ¡æº–èˆ‡ç›¸æ©Ÿè·é›¢ D</h2>
                
                <label for="actual_H">æ­¥é©Ÿä¸€ï¼šè¨­å®šå¯¦éš›æ¸¬é‡é•·åº¦ H (mm)</label>
                <p>è«‹å°‡ç›´å°º**å¹³è¡Œ**æ”¾ç½®ä¸¦å°é½Šç´…ç·šã€‚å¡«å¯«**ç¶ è‰²æ¨™è¨˜èˆ‡è—è‰²æ¨™è¨˜é–“çš„å¯¦éš›é•·åº¦**ã€‚</p>
                <input type="number" id="actual_H" value="100" min="1" required>

                <label style="margin-top: 30px;">æ­¥é©ŸäºŒï¼šæ‹–æ›³æ¨™è¨˜</label>
                <p>æ‹–æ›³æ¨™è¨˜ç·šï¼Œä½¿å…¶å°é½Šæ‚¨ç›´å°ºä¸Š H é•·åº¦çš„å…©ç«¯é»ã€‚</p>
                
                <div class="result">
                    <h3>å³æ™‚è¨ˆç®—çµæœ</h3>
                    <p>æ¸¬é‡å¯¦éš›é•·åº¦ Hï¼š<span id="display-H" class="highlight">100 mm</span></p>
                    <p>ç•«é¢åƒç´ é•·åº¦ hï¼š<span id="display-h" class="highlight">--- px</span></p>
                    
                    <!-- æ–°å¢åƒç´ å°ºåº¦é¡¯ç¤º -->
                    <p style="font-size: 1.1em; font-weight: bold; margin-top: 15px;">åœ¨ç•¶å‰è·é›¢ä¸‹ï¼Œåƒç´ å°ºåº¦ç‚ºï¼š</p>
                    <div class="highlight" id="display-pixel-scale" style="font-size: 1.8em; color: #333;">--- mm/px</div>

                    <p>è¨ˆç®—å‡ºçš„ç•«é¢å…¨å¯¬ Wï¼š<span id="display-W">---</span></p>
                    <p style="font-size: 1.3em; font-weight: bold; margin-top: 15px;">æ”å½±æ©Ÿåˆ°ç›´å°ºçš„è·é›¢ Dï¼š</p>
                    <div class="highlight" id="display-D">---</div>
                </div>

                <p style="margin-top: 30px; font-size: 0.9em; color: #999; text-align: right;">
                    **ç›¸æ©Ÿåƒæ•¸ï¼š** Focal/Sensor Ratio (f/d) = **{{ "%.4f"|format(ratio) }}**
                </p>
            </div>
            
            <!-- çª—å£ç‰©é«”è·é›¢è¨ˆç®—å€å¡Š (èˆ‡ä¸Šæ¬¡ç›¸åŒ) -->
            <div class="section-box">
                <h2>2. çª—å£ç‰©é«”è·é›¢è¨ˆç®—</h2>
                <p>ç”¨æ–¼è¨ˆç®—é€éç‰¹å®šçª—å£çœ‹åˆ°ç®±å…§ç‰©é«”çš„**æœ€å°**è·é›¢ $X$ã€‚</p>
                
                <label for="window_diameter_Hw">çª—å£å¯¦éš›ç›´å¾‘ $H_W$ (mm)</label>
                <input type="number" id="window_diameter_Hw" value="150" min="1" required>
                
                <label for="camera_to_window_Dw">æ”å½±æ©Ÿåˆ°çª—å£è·é›¢ $D_W$ (mm)</label>
                <input type="number" id="camera_to_window_Dw" value="128" min="1" required>
                
                <label for="box_object_Hb">ç®±å…§ç‰©é«”å¯¦éš›é•·åº¦ $H_B$ (mm)</label>
                <input type="number" id="box_object_Hb" value="245" min="1" required>
                
                <div class="result" style="border-color: #007bff; background-color: #e6f7ff; margin-top: 25px;">
                    <h3>è¨ˆç®—çµæœ</h3>
                    <p style="font-size: 1.3em; font-weight: bold; margin-top: 15px;">ç‰©é«”èˆ‡çª—å£çš„æœ€å°è·é›¢ $X$ï¼š</p>
                    <div class="highlight-blue" id="display-X">---</div>
                    <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                        *è‹¥ $H_B$ å¤§æ–¼ $H_W$ ä¸” $X$ ç‚ºæ­£å€¼ï¼Œè¡¨ç¤ºæ­¤è·é›¢æ‰èƒ½çœ‹åˆ°å®Œæ•´ç‰©é«”ã€‚
                    </p>
                </div>
            </div>

        </div>
    </div>
    
    <script>
        // Python OpenCV å¯¦éš›è§£æåº¦
        const PYTHON_CAMERA_WIDTH = 640; 
        
        // æ‹–æ›³ç›¸é—œè®Šæ•¸
        let start_x_display = 0; 
        let end_x_display = 0;   
        let actual_H = 100; // é è¨­ 100mm (æ­¥é©Ÿä¸€ï¼šç›´å°ºå¯¦éš›é•·åº¦ H)
        
        // çª—å£è¨ˆç®—ç›¸é—œè®Šæ•¸ (æ­¥é©ŸäºŒ)
        let Hw = 150; // çª—å£å¯¦éš›ç›´å¾‘
        let Dw = 128; // æ”å½±æ©Ÿåˆ°çª—å£è·é›¢
        let Hb = 245; // ç®±å…§ç‰©é«”å¯¦éš›é•·åº¦


        // --- æ‹–æ›³äº‹ä»¶è™•ç† (èˆ‡ä¸Šæ¬¡ç›¸åŒ) ---
        $(function() {
            const videoContainer = document.getElementById('video-container');
            const markers = document.querySelectorAll('.marker');

            // è¼”åŠ©å‡½æ•¸ï¼šå–å¾—ç•¶å‰å½±åƒå®¹å™¨çš„å¯¬åº¦
            function getCurrentVideoWidth() {
                return videoContainer.offsetWidth;
            }
            
            // è¼”åŠ©å‡½æ•¸ï¼šåˆå§‹åŒ–æˆ–æ›´æ–°æ¨™è¨˜ä½ç½®
            function updateMarkerPositions() {
                const currentWidth = getCurrentVideoWidth();
                
                start_x_display = currentWidth * 0.15;
                end_x_display = currentWidth * 0.75;
                
                document.getElementById('marker-start').style.left = start_x_display + 'px';
                document.getElementById('marker-end').style.left = end_x_display + 'px';
                
                // åŸ·è¡Œåˆå§‹è¨ˆç®— (æ­¥é©Ÿä¸€)
                sendCalculationData();
            }

            // åœ¨è¦–çª—èª¿æ•´å¤§å°æ™‚é‡æ–°è¨ˆç®—ä½ç½®
            window.addEventListener('resize', updateMarkerPositions);
            
            // åˆå§‹åŒ–
            updateMarkerPositions();
            
            markers.forEach(marker => {
                let isDragging = false;
                let startClientX = 0;
                let startLeft = 0;
                let markerId = marker.id;

                marker.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    startClientX = e.clientX;
                    startLeft = parseFloat(getComputedStyle(marker).left);
                    e.preventDefault(); 
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    
                    const currentWidth = getCurrentVideoWidth();
                    let deltaX = e.clientX - startClientX;
                    let newLeft = startLeft + deltaX;

                    // é™åˆ¶ç¯„åœç‚º 0 åˆ° currentWidth (è®“æ¨™è¨˜ä¸­å¿ƒç·šå¯ä»¥å®Œå…¨è²¼é½Šé‚Šç·£)
                    newLeft = Math.max(0, Math.min(currentWidth, newLeft)); 
                    marker.style.left = newLeft + 'px';
                    
                    if (markerId === 'marker-start') {
                        start_x_display = newLeft;
                    } else {
                        end_x_display = newLeft;
                    }
                    
                    sendCalculationData();
                });

                document.addEventListener('mouseup', () => {
                    if (isDragging) {
                        isDragging = false;
                        sendCalculationData(); 
                    }
                });
                
                // è§¸æ§äº‹ä»¶è™•ç† (èˆ‡ä¸Šæ¬¡ç›¸åŒ)
                marker.addEventListener('touchstart', (e) => {
                    if (e.touches.length === 1) {
                        isDragging = true;
                        startClientX = e.touches[0].clientX;
                        startLeft = parseFloat(getComputedStyle(marker).left);
                        e.preventDefault(); 
                    }
                });

                document.addEventListener('touchmove', (e) => {
                    if (!isDragging || e.touches.length !== 1) return;
                    
                    const currentWidth = getCurrentVideoWidth();
                    let deltaX = e.touches[0].clientX - startClientX;
                    let newLeft = startLeft + deltaX;

                    newLeft = Math.max(0, Math.min(currentWidth, newLeft)); 
                    marker.style.left = newLeft + 'px';
                    
                    if (markerId === 'marker-start') {
                        start_x_display = newLeft;
                    } else {
                        end_x_display = newLeft;
                    }
                    
                    sendCalculationData();
                });

                document.addEventListener('touchend', () => {
                    if (isDragging) {
                        isDragging = false;
                        sendCalculationData();
                    }
                });
            });
            
            // æ­¥é©Ÿä¸€ï¼šç›´å°º H è¼¸å…¥æ¡†äº‹ä»¶
            $('#actual_H').on('input', function() {
                actual_H = parseFloat($(this).val());
                if (isNaN(actual_H) || actual_H <= 0) {
                     $('#display-H').text('ç„¡æ•ˆå€¼');
                     $('#display-pixel-scale').text('---'); // æ¸…é™¤åƒç´ å°ºåº¦
                     return;
                }
                $('#display-H').text(actual_H + ' mm');
                sendCalculationData();
            });

            // æ­¥é©ŸäºŒï¼šçª—å£è¨ˆç®—è¼¸å…¥æ¡†äº‹ä»¶
            $('#window_diameter_Hw, #camera_to_window_Dw, #box_object_Hb').on('input', function() {
                Hw = parseFloat($('#window_diameter_Hw').val());
                Dw = parseFloat($('#camera_to_window_Dw').val());
                Hb = parseFloat($('#box_object_Hb').val());
                calculateWindowDistance(); 
            });
            
            // åˆå§‹åŸ·è¡Œä¸€æ¬¡çª—å£è¨ˆç®—
            calculateWindowDistance();
            
            // åˆå§‹é¡¯ç¤º H
            $('#display-H').text(actual_H + ' mm');
        });

        // --- çª—å£è·é›¢è¨ˆç®—å‡½æ•¸ ---
        function calculateWindowDistance() {
            // ... (èˆ‡ä¸Šæ¬¡ç›¸åŒï¼Œä¸éœ€è¦ä¿®æ”¹)
            if (isNaN(Hw) || Hw <= 0 || isNaN(Dw) || Dw <= 0 || isNaN(Hb) || Hb <= 0) {
                 $('#display-X').text('---');
                 return;
            }
            
            let X = Dw * (Hb / Hw - 1);
            
            if (X < 0) {
                $('#display-X').html(`0 mm<br><span style="font-size: 0.5em; color: #28a745;">(ç‰©é«”æ¯”çª—å£å°ï¼Œå·²å®Œæ•´çœ‹åˆ°)</span>`);
            } else {
                $('#display-X').text(X.toFixed(2) + ' mm');
            }
        }


        // --- AJAX å‚³è¼¸å’Œç›¸æ©Ÿè·é›¢è¨ˆç®—å‡½æ•¸ (æ­¥é©Ÿä¸€) ---
        function sendCalculationData() {
            if (isNaN(actual_H) || actual_H <= 0) {
                return;
            }
            
            const currentVideoWidth = document.getElementById('video-container').offsetWidth;
            if (currentVideoWidth === 0) return; 

            // 1. è¨ˆç®—ç¸®æ”¾å› å­å’Œ Python åŸºæº–åº§æ¨™
            const SCALE_FACTOR = currentVideoWidth / PYTHON_CAMERA_WIDTH; 
            const start_x_python = start_x_display / SCALE_FACTOR;
            const end_x_python = end_x_display / SCALE_FACTOR;
            const pixel_h = Math.abs(start_x_python - end_x_python);
            
            // æª¢æŸ¥åƒç´ é•·åº¦æ˜¯å¦ç‚ºé›¶ï¼Œé¿å…é™¤ä»¥é›¶
            if (pixel_h < 1) {
                $('#display-h').text('---');
                $('#display-pixel-scale').text('---');
                return;
            }

            // 2. è¨ˆç®—åƒç´ å°ºåº¦ (H / h)
            const pixel_scale = actual_H / pixel_h;
            
            // 3. æ›´æ–°å‰ç«¯é¡¯ç¤º
            $('#display-h').text(Math.round(pixel_h) + ' px');
            $('#display-pixel-scale').text(pixel_scale.toFixed(3) + ' mm/px'); // é¡¯ç¤º 1px = X mm

            // 4. å‚³é€æ•¸æ“šåˆ°å¾Œç«¯è¨ˆç®— D
            const dataToSend = {
                start_x: start_x_python,
                end_x: end_x_python,
                actual_H: actual_H
            };
            
            $.ajax({
                url: '/calculate',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(dataToSend),
                success: function(response) {
                    if (response.success) {
                        $('#display-W').text(response.W + ' mm');
                        $('#display-D').text(response.distance_D + ' mm');
                    }
                },
                error: function(xhr, status, error) {
                    console.error("è¨ˆç®—å¤±æ•—:", error);
                    const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : 'ä¼ºæœå™¨éŒ¯èª¤';
                    $('#display-D').text(errorMsg);
                }
            });
        }
        
    </script>
</body>
</html>
